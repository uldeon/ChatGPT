<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ChatGPT - Pollinations</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
  <style>
    :root {
      --accent: #2a8cff;
      --bg-dark: #1e1f22;
      --text: #f0f0f0;
      --user-bubble: #2a8cff;
      --bot-bubble: #2c2c2e;
      --sidebar-width: 260px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      background-color: var(--bg-dark);
      color: var(--text);
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    .sidebar {
      width: var(--sidebar-width);
      background-color: #171717;
      border-right: 1px solid #3a3a3c;
      display: flex;
      flex-direction: column;
      padding: 10px;
      overflow-y: auto;
      position: fixed;
      left: 0;
      top: 0;
      height: 100vh;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      z-index: 1000;
    }

    .sidebar.show {
      transform: translateX(0);
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 999;
    }

    .overlay.show {
      opacity: 1;
      pointer-events: auto;
    }

    .sidebar h2 {
      font-size: 0.85rem;
      color: #888;
      margin: 10px 0;
      text-transform: uppercase;
      font-weight: 600;
    }

    .chat-item {
      padding: 10px;
      margin: 4px 0;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 0.9rem;
    }

    .chat-item:hover {
      background-color: #2a2a2c;
    }

    .chat-item.active {
      background-color: #2a2a2c;
    }

    .new-chat-btn {
      background: var(--accent);
      border: none;
      color: white;
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 20px;
    }

    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      width: 100%;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background-color: #2b2b2e;
      border-bottom: 1px solid #3a3a3c;
    }

    .menu-btn {
      background: none;
      border: none;
      color: var(--text);
      cursor: pointer;
      padding: 5px 10px;
      display: flex;
      align-items: center;
      margin-right: 10px;
      position: relative;
      width: 24px;
      height: 24px;
    }
  


    .header-left {
      display: flex;
      align-items: center;
    }

    header h1 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text);
      margin: 0;
    }

    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .heading {
      text-align: center;
      margin-top: 20vh;
      font-size: 1.5rem;
      color: #d0d0d0;
      opacity: 0.9;
      transition: opacity 0.5s ease-out;
    }

    .heading.fade-out {
      opacity: 0;
      pointer-events: none;
    }

    .message {
      margin: 10px 0;
      line-height: 1.5;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .user {
      align-self: flex-end;
      background: var(--user-bubble);
      color: white;
      border-radius: 18px 18px 0 18px;
      padding: 12px 16px;
      max-width: 70%;
      margin-right: 10px;
    }

    .bot {
      align-self: center;
      border-radius: 12px;
      padding: 8px;
      width: 100%;
      max-width: 800px;
      box-sizing: border-box;
    }

    .loading {
      align-self: center;
      padding: 12px 16px;
      color: #888;
      font-style: italic;
      animation: glow 1.5s ease-in-out infinite;
    }

    @keyframes glow {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }

    .code-block {
      position: relative;
      background: #282c34;
      border-radius: 10px;
      margin-top: 10px;
      padding: 10px;
      overflow-x: auto;
    }

    .code-buttons {
      position: absolute;
      top: 5px;
      right: 10px;
      display: flex;
      gap: 6px;
    }

    .code-button {
      background: #3a3a3c;
      border: none;
      color: #bbb;
      cursor: pointer;
      font-size: 0.85rem;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .code-button:hover {
      background: var(--accent);
      color: white;
    }

    form {
      display: flex;
      justify-content: center;
      padding: 20px;
      background: #2a2a2c;
      border-top: 1px solid #3a3a3c;
      position: relative;
    }

    .input-area {
      position: relative;
      background: #3a3a3d;
      border-radius: 28px;
      padding: 10px 45px 10px 45px;
      width: 95%;
      max-width: 1200px;
      display: flex;
      align-items: center;
    }

    .input-area input {
      flex: 1;
      border: none;
      background: transparent;
      color: white;
      font-size: 1rem;
      outline: none;
      padding: 10px;
    }

    .input-area button {
      position: absolute;
      border: none;
      color: white;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-plus {
      left: 10px;
      background: #4a4a4d;
    }

    .btn-plus:hover {
      background: #5a5a5d;
    }

    .btn-send {
      right: 10px;
      background: var(--accent);
    }

    .model-modal {
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: #2b2b2e;
      border: 1px solid #3a3a3c;
      border-radius: 12px;
      padding: 8px;
      display: none;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      z-index: 1000;
    }

    .model-modal.show {
      display: block;
      animation: slideUp 0.2s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    .model-option {
      padding: 12px 20px;
      cursor: pointer;
      border-radius: 8px;
      transition: background 0.2s;
      white-space: nowrap;
    }

    .model-option:hover {
      background: #3a3a3c;
    }

    .model-option.selected {
      background: var(--accent);
    }

    pre {
      margin: 0;
      padding: 10px 0;
    }

    code {
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="overlay" id="overlay"></div>
  
  <div class="sidebar">
    <button class="new-chat-btn" id="newChatBtn">+ Nouveau chat</button>
    <h2>Historique</h2>
    <div id="chatHistory"></div>
  </div>

  <div class="main-content">
    <header>
      <div class="header-left">
        <button class="menu-btn" id="menuBtn" title="Afficher les chats précédents">
  <img src="https://cdn-icons-png.flaticon.com/512/1828/1828859.png" width="19" height="19" alt="Menu" />
</button>
        <h1>&nbsp;&nbsp;ChatGPT</h1>
      </div>
    </header>

    <div id="chat">
      <div class="heading" id="heading"></div>
    </div>

    <form id="chatForm">
      <div class="input-area">
        <button type="button" class="btn-plus" id="plusBtn">＋</button>
        <input id="userInput" placeholder="Envoyez un message..." autocomplete="off" />
        <button type="submit" class="btn-send">⬆️</button>
      </div>
      <div class="model-modal" id="modelModal">
        <div class="model-option" data-model="openai">ChatGPT Deep</div>
        <div class="model-option" data-model="openai-fast">ChatGPT Fast</div>
      </div>
    </form>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.0/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <script>
    const headings = [
      "Toujours prêt à répondre",
      "Par quoi commençons-nous ?",
      "Qu'est-ce qui vous intéresse aujourd'hui ?",
      "Sur quoi travaillez-vous ?",
      "Quel est le programme aujourd'hui ?"
    ];
    
    const chat = document.getElementById("chat");
    const form = document.getElementById("chatForm");
    const input = document.getElementById("userInput");
    const plusBtn = document.getElementById("plusBtn");
    const modelModal = document.getElementById("modelModal");
    const heading = document.getElementById("heading");
    const chatHistory = document.getElementById("chatHistory");
    const newChatBtn = document.getElementById("newChatBtn");
    const menuBtn = document.getElementById("menuBtn");
    const sidebar = document.querySelector(".sidebar");
    const overlay = document.getElementById("overlay");
    
    let currentChatId = null;
    let currentModel = "openai";
    let chats = JSON.parse(localStorage.getItem('chats') || '{}');
    let isFirstMessage = true;

    // Toggle sidebar
    menuBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      sidebar.classList.toggle('show');
      overlay.classList.toggle('show');
    });

    // Close sidebar when clicking overlay
    overlay.addEventListener('click', () => {
      sidebar.classList.remove('show');
      overlay.classList.remove('show');
    });

    // Prevent sidebar from closing when clicking inside it
    sidebar.addEventListener('click', (e) => {
      e.stopPropagation();
    });

    function initializeChat() {
      heading.textContent = headings[Math.floor(Math.random() * headings.length)];
      renderChatHistory();
    }

    function truncateTitle(text, maxLength = 30) {
      return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    }

    function renderChatHistory() {
      chatHistory.innerHTML = '';
      const chatIds = Object.keys(chats).sort((a, b) => chats[b].timestamp - chats[a].timestamp);
      chatIds.forEach(id => {
        const div = document.createElement('div');
        div.className = 'chat-item' + (id === currentChatId ? ' active' : '');
        div.textContent = truncateTitle(chats[id].title);
        div.onclick = () => loadChat(id);
        chatHistory.appendChild(div);
      });
    }

    function saveChat() {
      if (currentChatId && chats[currentChatId]) {
        localStorage.setItem('chats', JSON.stringify(chats));
      }
    }

    function loadChat(id) {
      currentChatId = id;
      const chatData = chats[id];
      chat.innerHTML = '';
      
      chatData.messages.forEach(msg => {
        addMessage(msg.content, msg.role === 'user' ? 'user' : 'bot', false);
      });
      
      isFirstMessage = false;
      renderChatHistory();
    }

    function createNewChat() {
      currentChatId = Date.now().toString();
      chats[currentChatId] = {
        id: currentChatId,
        title: 'Nouveau chat',
        messages: [],
        timestamp: Date.now()
      };
      chat.innerHTML = '<div class="heading" id="heading"></div>';
      heading.textContent = headings[Math.floor(Math.random() * headings.length)];
      isFirstMessage = true;
      renderChatHistory();
    }

    newChatBtn.addEventListener('click', createNewChat);

    plusBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      modelModal.classList.toggle("show");
    });

    document.addEventListener('click', (e) => {
      if (!modelModal.contains(e.target) && e.target !== plusBtn) {
        modelModal.classList.remove('show');
      }
    });

    document.querySelectorAll('.model-option').forEach(option => {
      option.addEventListener('click', () => {
        currentModel = option.dataset.model;
        document.querySelectorAll('.model-option').forEach(o => o.classList.remove('selected'));
        option.classList.add('selected');
        modelModal.classList.remove('show');
      });
    });

    function addMessage(content, className, save = true) {
      const div = document.createElement("div");
      div.className = `message ${className}`;

      const codeRegex = /```(\w+)?\n([\s\S]*?)```/g;
      let lastIndex = 0;
      let fragments = [];

      while (true) {
        const match = codeRegex.exec(content);
        if (!match) break;
        if (match.index > lastIndex)
          fragments.push({ type: "text", content: content.slice(lastIndex, match.index) });
        fragments.push({ type: "code", lang: match[1] || '', content: match[2] });
        lastIndex = match.index + match[0].length;
      }
      if (lastIndex < content.length) fragments.push({ type: "text", content: content.slice(lastIndex) });

      fragments.forEach(frag => {
        if (frag.type === "text") {
          const span = document.createElement("span");
          try {
            span.innerHTML = marked.parse(frag.content || '');
          } catch {
            span.textContent = frag.content;
          }
          div.appendChild(span);
        } else if (frag.type === "code") {
          const wrapper = document.createElement("div");
          wrapper.className = "code-block";
          const pre = document.createElement("pre");
          const codeEl = document.createElement("code");
          codeEl.className = frag.lang ? `language-${frag.lang}` : '';
          codeEl.textContent = frag.content;

          const buttons = document.createElement("div");
          buttons.className = "code-buttons";

          const copyBtn = document.createElement("button");
          copyBtn.className = "code-button";
          copyBtn.textContent = "📋 Copier";
          copyBtn.onclick = () => {
            navigator.clipboard.writeText(frag.content);
            copyBtn.textContent = "✓ Copié";
            setTimeout(() => copyBtn.textContent = "📋 Copier", 2000);
          };

          const runBtn = document.createElement("button");
          runBtn.className = "code-button";
          runBtn.textContent = "▶️ Exécuter";
          runBtn.onclick = () => executeCode(frag.content, frag.lang);

          buttons.appendChild(copyBtn);
          buttons.appendChild(runBtn);

          pre.appendChild(codeEl);
          wrapper.appendChild(pre);
          wrapper.appendChild(buttons);
          div.appendChild(wrapper);

          hljs.highlightElement(codeEl);
        }
      });

      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;

      if (save && currentChatId) {
        chats[currentChatId].messages.push({
          role: className === 'user' ? 'user' : 'assistant',
          content: content
        });
        saveChat();
      }
    }

    function executeCode(code, lang) {
      try {
        lang = lang.toLowerCase();
        if (lang === 'js' || lang === 'javascript') {
          const result = eval(code);
          alert('Résultat: ' + (result !== undefined ? result : 'Code exécuté'));
        } else if (lang === 'python') {
          alert('Exécution Python non supportée dans le navigateur');
        } else if (lang === 'html') {
          const win = window.open('', '_blank');
          win.document.write(code);
        } else {
          alert('Langage non supporté pour l\'exécution');
        }
      } catch (e) {
        alert('Erreur: ' + e.message);
      }
    }

    function addLoadingIndicator() {
      const div = document.createElement("div");
      div.className = "message loading";
      div.id = "loading";
      div.textContent = "Génération en cours...";
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function removeLoadingIndicator() {
      const loading = document.getElementById("loading");
      if (loading) loading.remove();
    }

    form.addEventListener("submit", async e => {
      e.preventDefault();
      const message = input.value.trim();
      if (!message) return;

      if (!currentChatId) {
        createNewChat();
      }

      if (isFirstMessage) {
        heading.classList.add('fade-out');
        setTimeout(() => {
          heading.style.display = 'none';
        }, 500);
        chats[currentChatId].title = truncateTitle(message, 30);
        renderChatHistory();
        isFirstMessage = false;
      }

      addMessage(message, "user");
      input.value = "";
      
      addLoadingIndicator();

      try {
        const res = await fetch("https://text.pollinations.ai/" + currentModel, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            model: currentModel,
            messages: [
              { role: "system", content: "Tu es une IA nommée ChatGPT. Réponds naturellement et poliment." },
              { role: "user", content: message }
            ]
          })
        });

        removeLoadingIndicator();

        if (!res.ok) throw new Error(`Erreur API : ${res.status}`);
        const data = await res.json();
        const reply = data?.choices?.[0]?.message?.content || "(Aucune réponse)";
        addMessage(reply, "bot");
      } catch (err) {
        removeLoadingIndicator();
        addMessage("Erreur : " + err.message, "bot");
      }
    });

    initializeChat();
  </script>
</body>
</html>